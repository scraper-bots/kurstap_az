// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hashed password
  firstName String?
  lastName  String?
  imageUrl  String?
  
  // Email verification
  emailVerified DateTime?
  emailVerificationToken String?
  
  // Password reset
  resetPasswordToken String?
  resetPasswordTokenExpires DateTime?
  
  // User preferences and settings
  interviewCredits Int @default(0) // Number of interviews user can take
  role UserRole @default(USER)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  interviews    Interview[]
  sessions      Session[]
  subscriptions Subscription[]
  payments      Payment[]
  userSessions  UserSession[]
  
  @@map("users")
}

model UserSession {
  id        String   @id @default(cuid())
  sessionId String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_sessions")
}

model Interview {
  id          String        @id @default(cuid())
  userId      String
  title       String
  description String?
  position    String        // Job position being interviewed for
  company     String?       // Company name
  difficulty  Difficulty    @default(MEDIUM)
  mode        InterviewMode @default(STANDARD) // New: Interview mode with predefined settings
  status      InterviewStatus @default(SCHEDULED)
  
  // Interview content - now all questions provided at once
  questions   Json[]        // Array of detailed question objects with metadata
  totalQuestions Int         // Total number of questions for this interview
  duration    Int?          // Total duration in minutes
  feedback    String?       // AI feedback
  score       Float?        // Overall score (0-100)
  
  // Video recording and analysis
  videoUrl         String?   // URL to recorded video
  videoAnalysis    Json?     // AI analysis of video (facial expressions, body language, etc.)
  audioTranscript  String?   // Full transcript of the video
  
  // Detailed analysis data
  categoryScores    Json?     // Scores by category (Behavioral, Technical, etc.)
  overallAnalysis   Json?     // Strengths, weaknesses, recommendations
  responseMetrics   Json?     // Response time, confidence levels, facial analysis
  benchmarkData     Json?     // Industry comparison data
  improvementPlan   Json?     // Roadmap and resources
  
  // Scheduling
  scheduledAt DateTime?
  completedAt DateTime?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions  Session[]
  answers   InterviewAnswer[]
  
  @@map("interviews")
}

model InterviewAnswer {
  id          String    @id @default(cuid())
  interviewId String
  questionId  Int       // Question number/index
  question    String    // The actual question
  userAnswer  String    // User's response
  idealAnswer String?   // Ideal answer for comparison
  score       Float?    // Individual question score (0-100)
  strengths   String[]  // Array of strengths identified
  weaknesses  String[]  // Array of areas for improvement
  category    String    // Question category (Behavioral, Technical, etc.)
  responseTime Int?     // Time taken to respond in seconds
  confidence  Float?    // AI-assessed confidence level
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  interview Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  
  @@map("interview_answers")
}

model Session {
  id          String      @id @default(cuid())
  userId      String
  interviewId String?
  
  // Session data
  type        SessionType @default(PRACTICE)
  status      SessionStatus @default(IN_PROGRESS)
  duration    Int?        // Duration in seconds
  
  // Video/Audio data
  videoUrl    String?     // Video recording URL
  audioUrl    String?     // Audio-only URL (fallback)
  transcript  String?     // Speech-to-text transcript
  
  // Video analysis data
  videoAnalysis Json?     // Frame-by-frame analysis results
  facialMetrics Json?     // Facial expression analysis
  bodyLanguage  Json?     // Body language assessment
  eyeContact    Json?     // Eye contact tracking
  speechPacing  Json?     // Speech rhythm and pacing analysis
  
  // AI Analysis
  feedback    Json?       // Structured feedback JSON
  score       Float?      // Session score (0-100)
  
  // Timestamps
  startedAt   DateTime    @default(now())
  completedAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  interview Interview? @relation(fields: [interviewId], references: [id], onDelete: SetNull)
  
  @@map("sessions")
}

model Subscription {
  id        String           @id @default(cuid())
  userId    String
  
  // Subscription details - DEPRECATED: Moving to credit-only system
  type      String              @default("CREDIT_BASED") 
  status    SubscriptionStatus @default(ACTIVE)
  
  // Payment provider data
  stripeCustomerId       String?
  stripeSubscriptionId   String? @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  
  // Subscription periods
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  
  // Associated payment
  paymentId String?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  payment Payment? @relation(fields: [paymentId], references: [id])
  
  @@map("subscriptions")
}

model Payment {
  id        String        @id @default(cuid())
  userId    String
  
  // Order details
  orderId     String       @unique  // Unique order ID for Epoint
  amount      Float                 // Payment amount
  currency    String       @default("AZN")
  description String?
  
  // Payment status
  status      PaymentStatus @default(PENDING)
  
  // Epoint transaction data
  transactionId      String?  // Epoint transaction ID
  bankTransactionId  String?  // Bank transaction ID
  bankResponse       String?  // Bank response details
  responseCode       String?  // Response code from bank
  responseMessage    String?  // Response message
  rrn               String?  // Retrieval Reference Number
  cardName          String?  // Cardholder name
  cardMask          String?  // Masked card number
  
  // URLs for redirect
  successUrl String
  errorUrl   String
  
  // Error details
  errorMessage String?
  
  // Payment form data (for gateways that return HTML forms)
  formHtml String? // HTML form content for payment submission
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]
  
  @@map("payments")
}

// Enums
enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  UNPAID
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum InterviewStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum SessionType {
  PRACTICE
  MOCK_INTERVIEW
  SKILL_ASSESSMENT
}

enum SessionStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
  FAILED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum InterviewMode {
  QUICK_ASSESSMENT    // 3 questions, 5 minutes total
  STANDARD           // 5 questions, 15 minutes total
  COMPREHENSIVE      // 8 questions, 25 minutes total
  TECHNICAL_DEEP     // 10 questions, 35 minutes total, high difficulty
  BEHAVIORAL_FOCUS   // 6 questions, 20 minutes, behavioral only
  MIXED_CHALLENGE    // 12 questions, 45 minutes, all difficulties
}

enum UserRole {
  USER
  ADMIN
}
